---
# This playbook is intended to install tomcat7 with the webapp UI
# and includes users defined in tomcat-users.xml. Authbind is used to run tomcat7 on the specified port.
#
# Note: The set of tasks here may need to be updated for other versions of tomcat
# as configurations may change. When making variable changes observe:
#
# - ../shared/vars/main.yml
# - ../setup/vars/main.yml

# Install apt dependencies for tomcat7
- name: Install slave base apt dependencies for tomcat
  sudo: yes
  action: "{{ ansible_pkg_mgr }} pkg={{ item }} state=latest"
  with_items: slave.apt.tomcat
  when: slave.apt.tomcat is defined and install_tomcat
  register: tomcat_installed

- name: Change default tomcat port
  sudo: yes
  command: sed -i 's:port\=\"{{ tomcat.default_http_port | default(8080) }}\":port\=\"{{ tomcat.desired_http_port | default(80) }}\":' {{ tomcat.server_config_file }}
  when: install_tomcat and tomcat is defined

- name: Enable AUTHBIND for new tomcat port when port no. less than 1023
  sudo: yes
  command: sed -i 's:\#AUTHBIND\=no:AUTHBIND\=yes:' {{ tomcat.default_file }}
  when: install_tomcat and tomcat is defined and tomcat.desired_http_port < 1023

- name: Create authbind file for port when port no. less than 1023
  sudo: yes
  command: touch {{ authbind_path }}/{{ tomcat.desired_http_port }}
  when: install_tomcat and tomcat is defined and tomcat.desired_http_port < 1023

- name: Update permissions for authbind file when port no. less than 1023
  sudo: yes
  command: chmod 500 {{ authbind_path }}/{{ tomcat.desired_http_port }}
  when: install_tomcat and tomcat is defined and tomcat.desired_http_port < 1023

- name: Change owner for Authbind file to tomcat7 user
  sudo: yes
  command: chown {{ tomcat.user }} {{ authbind_path }}/{{ tomcat.desired_http_port }}
  when: install_tomcat and tomcat is defined and tomcat.desired_http_port < 1023

- name: Copy tomcat user configuration to machine
  sudo: yes
  copy: src={{ item }} dest={{ tomcat.users_path }} owner={{ tomcat.user | default('tomcat7') }} group={{ tomcat.user | default('tomcat7') }} backup=yes  mode=640
  with_fileglob:
        - "{{ local_files_dir }}/tomcat/tomcat-users.xml"
  when: install_tomcat and tomcat is defined
  register: tomcat_user_config_copied

- name: Restart tomcat service
  sudo: yes
  service: name=tomcat7 state=restarted
  when: tomcat_user_config_copied is defined and install_tomcat
